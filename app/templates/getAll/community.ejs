<%- include('./layout/header.ejs')%>

<section class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold text-primary mb-3">
            <i class="bi bi-people-fill me-3"></i>
            انجمن گروه کامپیوتر
        </h1>
        <p class="lead text-muted">مرکز تعامل، یادگیری و رشد دانشجویان گروه کامپیوتر</p>
    </div>

    <!-- Community Stats -->
    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card text-center border-0 shadow-sm">
                <div class="card-body py-4">
                    <i class="bi bi-people text-primary fs-1 mb-3"></i>
                    <h3 class="fw-bold text-primary" id="members-count">-</h3>
                    <p class="text-muted mb-0">عضو فعال</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center border-0 shadow-sm">
                <div class="card-body py-4">
                    <i class="bi bi-newspaper text-success fs-1 mb-3"></i>
                    <h3 class="fw-bold text-success" id="news-count">-</h3>
                    <p class="text-muted mb-0">خبر مرتبط</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center border-0 shadow-sm">
                <div class="card-body py-4">
                    <i class="bi bi-book text-warning fs-1 mb-3"></i>
                    <h3 class="fw-bold text-warning" id="courses-count">-</h3>
                    <p class="text-muted mb-0">دوره مرتبط</p>
                </div>
            </div>
        </div>
    </div>
    <!-- About Us Section -->
    <div class="mb-5">
        <h2 class="section-title">
            <i class="bi bi-info-circle me-2"></i>
            درباره انجمن
        </h2>
        <div id="about-us-loading" class="text-center py-4">
            <div class="spinner-border text-info" role="status"></div>
            <div class="mt-2">در حال بارگذاری اطلاعات...</div>
        </div>
        <div id="about-us-content" class="row g-4"></div>
    </div>

    <!-- Related News Section -->
    <div class="mb-5">
        <h2 class="section-title">
            <i class="bi bi-newspaper me-2"></i>
            اخبار و اطلاعیه‌های انجمن
        </h2>
        <div id="community-news-loading" class="text-center py-4">
            <div class="spinner-border text-primary" role="status"></div>
            <div class="mt-2">در حال بارگذاری اخبار...</div>
        </div>
        <div id="community-news" class="row g-4"></div>
    </div>


    <!-- Related Courses Section -->
    <div class="mb-5">
        <h2 class="section-title">
            <i class="bi bi-book me-2"></i>
            دوره‌های آموزشی انجمن
        </h2>
        <div id="community-courses-loading" class="text-center py-4">
            <div class="spinner-border text-warning" role="status"></div>
            <div class="mt-2">در حال بارگذاری دوره‌ها...</div>
        </div>
        <div id="community-courses" class="row g-4"></div>
    </div>

    <!-- Members Section -->
    <div class="mb-5">
        <h2 class="section-title">
            <i class="bi bi-people me-2"></i>
            اعضای فعلی انجمن
        </h2>
        <div id="members-loading" class="text-center py-4">
            <div class="spinner-border text-success" role="status"></div>
            <div class="mt-2">در حال بارگذاری اعضا...</div>
        </div>
        <div id="members-list" class="row g-4"></div>
    </div>

    <!-- Join Community Section -->
    <div id="join-community-section" class="text-center py-5" style="display: none;">
        <div class="card border-0 shadow-lg">
            <div class="card-body p-5">
                <i class="bi bi-people-fill text-primary fs-1 mb-4"></i>
                <h3 class="fw-bold mb-3">به انجمن گروه کامپیوتر بپیوندید</h3>
                <p class="text-muted mb-4">با پیوستن به انجمن، از آخرین اخبار، دوره‌ها و رویدادها مطلع شوید و با سایر دانشجویان در ارتباط باشید.</p>
                <button class="btn btn-primary btn-lg" onclick="showJoinModal()">
                    <i class="bi bi-person-plus me-2"></i>
                    پیوستن به انجمن
                </button>
            </div>
        </div>
    </div>

    <!-- Already Member Section -->
    <div id="already-member-section" class="text-center py-5" style="display: none;">
        <div class="card border-0 shadow-lg bg-success bg-opacity-10">
            <div class="card-body p-5">
                <i class="bi bi-check-circle-fill text-success fs-1 mb-4"></i>
                <h3 class="fw-bold mb-3 text-success">شما عضو انجمن هستید!</h3>
                <p class="text-muted mb-4">تبریک! شما قبلاً عضو انجمن گروه کامپیوتر شده‌اید و می‌توانید از تمام امکانات آن استفاده کنید.</p>
                <div class="alert alert-success">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>وضعیت عضویت:</strong> 
                    <span id="membership-status">در حال بررسی</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Required Section -->
    <div id="login-required-section" class="text-center py-5" style="display: none;">
        <div class="card border-0 shadow-lg bg-warning bg-opacity-10">
            <div class="card-body p-5">
                <i class="bi bi-exclamation-triangle-fill text-warning fs-1 mb-4"></i>
                <h3 class="fw-bold mb-3 text-warning">ورود الزامی است</h3>
                <p class="text-muted mb-4">برای استفاده از این گزینه، ابتدا وارد حساب کاربری خود شوید.</p>
                <a href="/login" class="btn btn-warning btn-lg">
                    <i class="bi bi-box-arrow-in-right me-2"></i>
                    ورود به حساب کاربری
                </a>
            </div>
        </div>
    </div>
</section>

<!-- Join Community Modal -->
<div class="modal fade" id="joinModal" tabindex="-1" aria-labelledby="joinModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="joinModalLabel">
                    <i class="bi bi-person-plus me-2"></i>
                    درخواست عضویت در انجمن
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="joinForm">
                    <div class="mb-3">
                        <label for="studentId" class="form-label fw-bold">
                            <i class="bi bi-person-badge me-1"></i>
                            کد دانشجویی
                        </label>
                        <input type="text" class="form-control" id="studentId" name="studentId" 
                               placeholder="کد دانشجویی 10 رقمی خود را وارد کنید" 
                               maxlength="10" required readonly>
                        <div class="form-text">کد دانشجویی شما به صورت خودکار پر شده است</div>
                    </div>
                    <div class="mb-3">
                        <label for="studentName" class="form-label fw-bold">
                            <i class="bi bi-person me-1"></i>
                            نام و نام خانوادگی
                        </label>
                        <input type="text" class="form-control" id="studentName" name="studentName" 
                               placeholder="نام و نام خانوادگی" readonly>
                        <div class="form-text">نام و نام خانوادگی شما به صورت خودکار پر شده است</div>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label fw-bold">
                            <i class="bi bi-chat-text me-1"></i>
                            دلیل پیوستن به انجمن
                        </label>
                        <textarea class="form-control" id="description" name="description" 
                                  rows="4" placeholder="دلیل خود برای پیوستن به انجمن گروه کامپیوتر را توضیح دهید..." required></textarea>
                        <div class="form-text">لطفاً دلیل خود برای پیوستن به انجمن را به طور کامل توضیح دهید</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                <button type="button" class="btn btn-primary" onclick="submitJoinRequest()">
                    <i class="bi bi-send me-2"></i>
                    ارسال درخواست
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.section-title {
    font-weight: bold;
    margin-bottom: 2rem;
    color: #2d3a4b;
    border-bottom: 3px solid #007bff;
    padding-bottom: 0.5rem;
}

.community-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
    cursor: pointer;
}

.community-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.community-image {
    height: 200px;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.community-card:hover .community-image {
    transform: scale(1.05);
}

.member-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: none;
    border-radius: 15px;
    transition: transform 0.3s ease;
}

.member-card:hover {
    transform: translateY(-3px);
}

.manager-card {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border: 3px solid #ffd700;
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
    animation: managerGlow 2s ease-in-out infinite alternate;
}

.manager-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
}

@keyframes managerGlow {
    0% {
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
    }
    100% {
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
    }
}

.member-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(45deg, #007bff, #0056b3);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1.2rem;
}

.manager-badge {
    background: linear-gradient(45deg, #28a745, #20c997);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 10px;
    font-size: 0.8rem;
}

.pending-badge {
    background: linear-gradient(45deg, #ffc107, #e0a800);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 10px;
    font-size: 0.8rem;
}

.accepted-badge {
    background: linear-gradient(45deg, #28a745, #20c997);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 10px;
    font-size: 0.8rem;
}

/* About Us Section Styles */
.about-section-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: none;
    border-radius: 0;
    box-shadow: none;
    transition: all 0.3s ease;
    overflow: hidden;
    position: relative;
    margin-bottom: 0;
}

.about-section-card:hover {
    transform: none;
    box-shadow: none;
}

.about-section-text {
    background: #f8f9fa;
    border: none;
    padding: 20px;
    border-radius: 0;
    font-size: 1.1rem;
    line-height: 1.8;
    text-align: justify;
}

.about-section-image {
    border-radius: 0;
    overflow: hidden;
    box-shadow: none;
}

.about-section-image img {
    width: 100%;
    height: 300px;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.about-section-card:hover .about-section-image img {
    transform: scale(1.05);
}

.about-section-file {
    background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
    border: none;
    border-radius: 0;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
}

.about-section-file:hover {
    background: linear-gradient(135deg, #ffe0b2 0%, #ffcc80 100%);
}

.about-section-file a {
    color: #e65100;
    text-decoration: none;
    font-weight: bold;
    font-size: 1.1rem;
}

.about-section-file a:hover {
    color: #bf360c;
}

.about-section-description {
    padding: 10px 15px;
    border-radius: 0;
    margin-top: 10px;
    color: #666;
    border-left: none;
}

.about-section-order {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: bold;
}

/* About Blog Styles */
.about-blog-container {
    max-width: 800px;
    margin: 0 auto;
}

.about-blog-item {
    margin-bottom: 0;
    position: relative;
}

.about-blog-item:not(:last-child)::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, #e0e0e0, transparent);
}

.about-blog-item:last-child {
    margin-bottom: 0;
}

.tag-badge {
    display: inline-block;
    background: linear-gradient(45deg, #17a2b8, #138496);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 15px;
    font-size: 0.75rem;
    margin: 0.1rem;
    white-space: nowrap;
}

.type-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 2;
    font-weight: bold;
    padding: 0.5rem 1rem;
    border-radius: 20px;
}

.description-text {
    background: white;
    border-radius: 8px;
    padding: 0.75rem;
    border-left: 4px solid #007bff;
    font-style: italic;
    color: #6c757d;
    margin-top: 0.5rem;
    max-height: 80px;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
}

.about-section-title {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    padding: 15px 20px;
    margin: -1.5rem -1.5rem 1rem -1.5rem;
    border-radius: 0;
    text-align: center;
}

.about-section-title h4 {
    margin: 0;
    font-weight: bold;
    font-size: 1.2rem;
}
</style>



<script>
let communityData = {
    news: [],
    courses: [],
    members: [],
    aboutUs: []
};

let currentUser = null;
let userMembership = null;

document.addEventListener('DOMContentLoaded', function() {
    loadCommunityData();
    checkUserStatus();
});

async function loadCommunityData() {
    try {
        // Load news with community tag
        const newsResponse = await apiRequest('/news', 'GET');
        if (newsResponse.success) {
            communityData.news = newsResponse.data.filter(item => 
                item.tags && item.tags.toLowerCase().includes('انجمن')
            );
        }

        // Load courses with community tag
        const coursesResponse = await apiRequest('/courses', 'GET');
        if (coursesResponse.success) {
            communityData.courses = coursesResponse.data.filter(item => 
                item.tags && item.tags.toLowerCase().includes('انجمن')
            );
        }

        // Load community members
        const membersResponse = await apiRequest('/community', 'GET');
        if (membersResponse.success) {
            communityData.members = membersResponse.data;
        }

        // Load about us sections
        const aboutUsResponse = await apiRequest('/about-us', 'GET');
        if (aboutUsResponse.success) {
            communityData.aboutUs = aboutUsResponse.data;
        }

        // Update stats
        updateStats();
        
        // Render sections
        renderCommunityNews();
        renderAboutUs();
        renderCommunityCourses();
        renderMembers();

    } catch (error) {
        console.error('Error loading community data:', error);
        showError('خطا در بارگذاری اطلاعات انجمن');
    }
}

async function checkUserStatus() {
    try {
        // Check if user is logged in
        const authResponse = await apiRequest('/auth/me', 'GET');
        
        if (!authResponse || !authResponse.success) {
            // User not logged in
            showLoginRequired();
            return;
        }
        
        currentUser = authResponse.data.user;
        
        // Check if user is a student
        if (currentUser.type !== 'student') {
            showLoginRequired();
            return;
        }
        
        // Check if user is already a member
        await checkUserMembership();
        
    } catch (error) {
        console.error('Error checking user status:', error);
        showLoginRequired();
    }
}

async function checkUserMembership() {
    try {
        const response = await apiRequest('/community', 'GET');
        
        if (response && response.success) {
            const members = response.data;
            console.log('Current user:', currentUser);
            console.log('All members:', members);
            
            userMembership = members.find(member => 
                member.Student && (member.Student.id === currentUser.id || member.studentId === currentUser.id)
            );
            
            console.log('User membership:', userMembership);
            
            if (userMembership) {
                showAlreadyMember();
            } else {
                showJoinSection();
            }
        } else {
            showJoinSection();
        }
        
    } catch (error) {
        console.error('Error checking membership:', error);
        showJoinSection();
    }
}

function showLoginRequired() {
    document.getElementById('join-community-section').style.display = 'none';
    document.getElementById('already-member-section').style.display = 'none';
    document.getElementById('login-required-section').style.display = 'block';
}

function showAlreadyMember() {
    document.getElementById('join-community-section').style.display = 'none';
    document.getElementById('login-required-section').style.display = 'none';
    document.getElementById('already-member-section').style.display = 'block';
    
    // Update membership status
    let statusText = 'در حال بررسی';
    let statusClass = 'text-warning';
    
    if (userMembership.isAccepted === true) {
        statusText = 'عضو';
        statusClass = 'text-success';
    } else if (userMembership.isAccepted === false) {
        statusText = 'در حال بررسی';
        statusClass = 'text-danger';
    }
    
    if (userMembership.isManager) {
        statusText += ' (مدیر)';
    }
    
    const statusElement = document.getElementById('membership-status');
    statusElement.textContent = statusText;
    statusElement.className = statusClass;
}

function showJoinSection() {
    document.getElementById('already-member-section').style.display = 'none';
    document.getElementById('login-required-section').style.display = 'none';
    document.getElementById('join-community-section').style.display = 'block';
}

function updateStats() {
    document.getElementById('members-count').textContent = communityData.members.length;
    document.getElementById('news-count').textContent = communityData.news.length;
    document.getElementById('courses-count').textContent = communityData.courses.length;
}

function renderCommunityNews() {
    const container = document.getElementById('community-news');
    const loading = document.getElementById('community-news-loading');
    
    loading.style.display = 'none';
    
    if (communityData.news.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    خبر مرتبط با انجمن یافت نشد.
                </div>
            </div>
        `;
        return;
    }

    let html = '';
    communityData.news.slice(0, 6).forEach(news => {
        // Tags
        let tagsHtml = '';
        if (news.tags) {
            const tags = news.tags.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
            tagsHtml = tags.map(tag => `<span class="tag-badge">${tag}</span>`).join('');
        }

        // Type
        let typeLabel = news.type === 'announcement' ? 'اطلاعیه' : 'خبر';
        let typeColor = news.type === 'announcement' ? 'danger' : 'primary';
        let typeIcon = news.type === 'announcement' ? 'bi-megaphone' : 'bi-newspaper';

        // Image
        let imgHtml = '';
        if (news.image && news.image !== '-' && news.image !== 'null') {
            imgHtml = `
                <div class="position-relative">
                    <img src="${news.image}" class="community-image w-100" alt="${news.title}">
                    <span class="type-badge badge bg-${typeColor}">${typeLabel}</span>
                </div>
            `;
        } else {
            imgHtml = `
                <div class="position-relative" style="height:200px;background:linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    <div class="d-flex flex-column align-items-center justify-content-center h-100">
                        <i class="bi bi-image fs-1 text-secondary"></i>
                        <div class="text-muted small">تصویر ندارد</div>
                    </div>
                    <span class="type-badge badge bg-${typeColor}">${typeLabel}</span>
                </div>
            `;
        }

        // Date
        let dateHtml = '';
        if (news.createdAt) {
            const date = new Date(news.createdAt);
            const persianDate = date.toLocaleDateString('fa-IR');
            dateHtml = `<small class="text-muted"><i class="bi bi-calendar ms-1"></i>${persianDate}</small>`;
        }

        html += `
            <div class="col-lg-4 col-md-6">
                <div class="card community-card h-100" onclick="window.location.href='/news/${news.id}'">
                    ${imgHtml}
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center mb-3">
                            <i class="bi ${typeIcon} text-${typeColor} fs-4 me-2"></i>
                            <div class="flex-grow-1">
                                <h6 class="fw-bold mb-1">${news.title || ''}</h6>
                                ${dateHtml}
                            </div>
                        </div>
                        
                        ${tagsHtml ? `
                            <div class="mb-3">
                                ${tagsHtml}
                            </div>
                        ` : ''}
                        
                        ${news.description ? `
                            <div class="description-text">
                                <i class="bi bi-chat-quote"></i>
                                ${news.description}
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function renderCommunityCourses() {
    const container = document.getElementById('community-courses');
    const loading = document.getElementById('community-courses-loading');
    
    loading.style.display = 'none';
    
    if (communityData.courses.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    دوره مرتبط با انجمن یافت نشد.
                </div>
            </div>
        `;
        return;
    }

    let html = '';
    communityData.courses.slice(0, 6).forEach(course => {
        // Tags
        let tagsHtml = '';
        if (course.tags) {
            const tags = course.tags.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
            tagsHtml = tags.map(tag => `<span class="tag-badge">${tag}</span>`).join('');
        }

        // Type
        let typeLabel = 'دوره';
        let typeColor = 'primary';
        if (course.type === 'event') { typeLabel = 'رویداد'; typeColor = 'warning'; }
        if (course.type === 'competition') { typeLabel = 'مسابقه'; typeColor = 'success'; }

        // Image
        let imgHtml = '';
        if (course.thumbnail && course.thumbnail !== '-' && course.thumbnail !== 'null') {
            imgHtml = `
                <div class="position-relative">
                    <img src="${course.thumbnail}" class="community-image w-100" alt="${course.title}">
                    <span class="type-badge badge bg-${typeColor}">${typeLabel}</span>
                </div>
            `;
        } else {
            imgHtml = `
                <div class="position-relative" style="height:200px;background:linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    <div class="d-flex flex-column align-items-center justify-content-center h-100">
                        <i class="bi bi-image fs-1 text-secondary"></i>
                        <div class="text-muted small">تصویر ندارد</div>
                    </div>
                    <span class="type-badge badge bg-${typeColor}">${typeLabel}</span>
                </div>
            `;
        }

        // Price
        let priceHtml = '';
        if (course.isAvailable) {
            if (course.price == 0) {
                priceHtml = `<span class="badge bg-success">رایگان</span>`;
            } else {
                priceHtml = `<span class="badge bg-warning">${course.price.toLocaleString()} تومان</span>`;
            }
        }

        html += `
            <div class="col-lg-4 col-md-6">
                <div class="card community-card h-100" onclick="window.location.href='/courses/${course.id}'">
                    ${imgHtml}
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h6 class="fw-bold mb-0">${course.title || ''}</h6>
                            ${priceHtml}
                        </div>
                        
                        ${tagsHtml ? `
                            <div class="mb-3">
                                ${tagsHtml}
                            </div>
                        ` : ''}
                        
                        ${course.description ? `
                            <div class="description-text">
                                <i class="bi bi-chat-quote"></i>
                                ${course.description}
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function renderAboutUs() {
    const container = document.getElementById('about-us-content');
    const loading = document.getElementById('about-us-loading');
    
    loading.style.display = 'none';
    
    if (communityData.aboutUs.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    اطلاعاتی درباره انجمن موجود نیست.
                </div>
            </div>
        `;
        return;
    }

    let html = '<div class="col-12">';
    html += '<div class="about-blog-container">';
    
    communityData.aboutUs.forEach(section => {
        let sectionHtml = '';
        
        switch (section.type) {
            case 'text':
                sectionHtml = `
                    <div class="about-section-text">
                        ${section.textContent || ''}
                    </div>
                `;
                break;
            case 'image':
                sectionHtml = `
                    <div class="about-section-image">
                        <img src="${section.imagePath}" alt="تصویر درباره انجمن" class="w-100">
                    </div>
                `;
                break;
            case 'file':
                const fileName = section.filePath ? section.filePath.split('/').pop() : 'فایل';
                sectionHtml = `
                    <div class="about-section-file">
                        <i class="bi bi-file-earmark-arrow-down fs-1 mb-3"></i>
                        <br>
                        <a href="${section.filePath}" target="_blank" download>
                            <i class="bi bi-download me-2"></i>
                            دانلود ${fileName}
                        </a>
                    </div>
                `;
                break;
        }
        
        html += `
        <hr>
            <div class="about-blog-item">
                <div class="about-section-card">
                    ${section.title ? `
                        <div class="about-section-title">
                            <h4 class="mb-3"><i class="bi bi-tag me-2"></i>${section.title}</h4>
                        </div>
                    ` : ''}

                    <h4 class="mb-3">${section.description}</h4>
                    
                    ${sectionHtml ? `
                        <div class="about-section-description">
                            ${sectionHtml}
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    html += '</div></div>';
    container.innerHTML = html;
}

function renderMembers() {
    const container = document.getElementById('members-list');
    const loading = document.getElementById('members-loading');
    
    loading.style.display = 'none';
    
    if (communityData.members.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    هنوز عضوی در انجمن وجود ندارد.
                </div>
            </div>
        `;
        return;
    }

    let html = '';
    communityData.members.forEach(member => {
        const student = member.Student || {};
        const fullName = `${student.firstName || ''} ${student.lastName || ''}`.trim();
        const initials = fullName.split(' ').map(n => n.charAt(0)).join('').toUpperCase();
        
        let statusBadge = '';
        let cardClass = 'card member-card h-100';
        
        if (member.isManager) {
            statusBadge = '<span class="manager-badge"><i class="bi bi-star-fill me-1"></i>مدیر</span>';
            cardClass += ' manager-card';
        } else if (member.isAccepted === true) {
            statusBadge = '<span class="accepted-badge"><i class="bi bi-check-circle me-1"></i>عضو</span>';
        } else if (member.isAccepted === false) {
            statusBadge = '<span class="badge bg-info"><i class="bi bi-x-circle me-1"></i>در انتظار</span>';
        } else {
            statusBadge = '<span class="pending-badge"><i class="bi bi-clock me-1"></i>در انتظار</span>';
        }

        const joinDate = member.createdAt ? new Date(member.createdAt).toLocaleDateString('fa-IR') : '';

        html += `
            <div class="col-lg-4 col-md-6">
                <div class="${cardClass}">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="member-avatar me-3">
                                ${student.profileImage && student.profileImage !== '-' && student.profileImage !== 'null' 
                                    ? `<img src="${student.profileImage}" alt="عکس پروفایل" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`
                                    : `${initials || '?'}`
                                }
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="fw-bold mb-1">${fullName || 'نامشخص'}</h6>
                            </div>
                            ${statusBadge}
                        </div>
                        ${joinDate ? `
                            <div class="text-center mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-calendar-plus me-1"></i>
                                    تاریخ عضویت: ${joinDate}
                                </small>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function showJoinModal() {
    // Check if user is logged in
    if (!currentUser) {
        Swal.fire({
            title: 'ورود الزامی است',
            text: 'برای استفاده از این گزینه باید وارد حساب کاربری خود شوید',
            icon: 'warning',
            confirmButtonText: 'ورود',
            showCancelButton: true,
            cancelButtonText: 'انصراف'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = '/login';
            }
        });
        return;
    }
    
    // Auto-fill user information
    document.getElementById('studentId').value = currentUser.studentId || currentUser.id || '';
    document.getElementById('studentName').value = `${currentUser.firstName || ''} ${currentUser.lastName || ''}`.trim();
    document.getElementById('description').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('joinModal'));
    modal.show();
}

async function submitJoinRequest() {
    const studentId = document.getElementById('studentId').value.trim();
    const description = document.getElementById('description').value.trim();

    if (!studentId) {
        Swal.fire('خطا', 'کد دانشجویی یافت نشد', 'error');
        return;
    }

    if (!description) {
        Swal.fire('خطا', 'لطفاً دلیل پیوستن به انجمن را توضیح دهید', 'error');
        return;
    }

    try {
        const response = await apiRequest('/community', 'POST', {
            studentId: studentId,
            description: description
        });

        if (response && response.success) {
            Swal.fire({
                title: 'درخواست ارسال شد',
                text: 'درخواست عضویت شما با موفقیت ثبت شد. پس از بررسی، نتیجه به شما اطلاع داده خواهد شد.',
                icon: 'success',
                confirmButtonText: 'باشه'
            });
            
            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('joinModal'));
            modal.hide();
            document.getElementById('joinForm').reset();
            
            // Reload membership status
            await checkUserMembership();
            
            // Reload members data
            const membersResponse = await apiRequest('/community', 'GET');
            if (membersResponse && membersResponse.success) {
                communityData.members = membersResponse.data;
                updateStats();
                renderMembers();
            }
        } else {
            Swal.fire('خطا', response ? response.message : 'خطا در ثبت درخواست عضویت', 'error');
        }
    } catch (error) {
        console.error('Error submitting join request:', error);
        Swal.fire('خطا', 'خطا در ارتباط با سرور. لطفاً دوباره تلاش کنید.', 'error');
    }
}

function showError(message) {
    // You can implement a better error display here
    alert(message);
}
</script>

<%- include('./layout/footer.ejs')%>