<div id="dashboard-content" class="content-panel">
    <h3 class="mb-4"><i class="bi bi-speedometer2"></i> داشبورد</h3>
    
    <div class="row">

        <div class="dashboard-card">
            <h5><i class="bi bi-graph-up"></i> آمار کلی</h5>
            <p class="mb-0">سیستم شما در حال کارکرد عالی است. تمام سرویس‌ها فعال هستند.</p>
        </div>

        <div class="col-md-6 col-lg-3 mb-4">
            <div class="stats-card">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="text-primary" id="studentCount">...</h4>
                        <p class="text-muted mb-0">کل‌دانشجویان</p>
                    </div>
                    <div class="text-primary">
                        <i class="bi bi-people fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="stats-card">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="text-success" id="teacherCount">...</h4>
                        <p class="text-muted mb-0">تعداد اساتید</p>
                    </div>
                    <div class="text-success">
                        <i class="bi bi-person-badge fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="stats-card">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="text-warning" id="communityCount">...</h4>
                        <p class="text-muted mb-0">اعضای‌انجمن</p>
                    </div>
                    <div class="text-warning">
                        <i class="bi bi-people-fill fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="stats-card">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="text-info" id="trainingCount">...</h4>
                        <p class="text-muted mb-0">فایل‌آموزشی</p>
                    </div>
                    <div class="text-info">
                        <i class="bi bi-journal-richtext fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    

    <div class="dashboard-card mt-4">
        <h5><i class="bi bi-bar-chart"></i> آمار سایت</h5>
        <div class="row" id="siteStatsRow">
            <div class="col-12 text-center text-muted">در حال بارگذاری...</div>
        </div>
    </div>


    <div class="card-body">
         <div id="log-table"></div>
    </div>

</div>
<script>
// بارگذاری آمار داشبورد
async function loadDashboardStats() {
    try {
        const response = await apiRequest('/dashboard-stats', 'GET');
        if (response && response.success) {
            const d = response.data;
            document.getElementById('studentCount').textContent = d.studentCount;
            document.getElementById('teacherCount').textContent = d.teacherCount;
            document.getElementById('communityCount').textContent = d.communityCount;
            document.getElementById('trainingCount').textContent = d.trainingCount;
        }
    } catch (e) {
        // fallback: ...
    }
}

async function loadSiteStats() {
    try {
        const res = await fetch('/api/site-stats');
        const stats = await res.json();
        const row = document.getElementById('siteStatsRow');
        row.innerHTML = '';
        const statList = [
            { label: 'کاربران آنلاین', value: stats.onlineUsers ?? '-', icon: 'bi bi-wifi', color: 'info' },
            { label: 'کل رزروها', value: stats.reservationCount, icon: 'bi bi-calendar-check', color: 'success' },
            { label: 'کل نظرسنجی‌ها', value: stats.pollCount, icon: 'bi bi-bar-chart-steps', color: 'secondary' },
            { label: 'کل رای‌ها', value: stats.pollVoteCount, icon: 'bi bi-check2-square', color: 'danger' },
        ];
        statList.forEach(stat => {
            const col = document.createElement('div');
            col.className = 'col-md-3 col-6 mb-3';
            col.innerHTML = `
                <div class="card border-${stat.color} shadow-sm h-100">
                    <div class="card-body text-center">
                        <i class="${stat.icon} fs-2 text-${stat.color}"></i>
                        <h4 class="fw-bold mt-2">${stat.value}</h4>
                        <p class="mb-0 text-muted">${stat.label}</p>
                    </div>
                </div>
            `;
            row.appendChild(col);
        });
    } catch (e) {
        document.getElementById('siteStatsRow').innerHTML = '<div class="col-12 text-center text-danger">خطا در دریافت آمار سایت</div>';
    }
}

if (document.getElementById('dashboard-content')) {
    document.addEventListener('DOMContentLoaded', () => {
        loadDashboardStats();
        loadSiteStats();
    });
}

 // تبدیل تاریخ میلادی به شمسی
 function toPersianDate(dateStr) {
    const g_days_in_month = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
    const j_days_in_month = [31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 30, 29];

    function div(a, b) {
        return Math.floor(a / b);
    }

    function gregorianToJalali(gy, gm, gd) {
        let g_day_no = 365 * (gy - 1600) + div((gy - 1600 + 3), 4) - div((gy - 1600 + 99), 100) + div((gy - 1600 + 399), 400);

        for (let i = 0; i < gm - 1; ++i)
            g_day_no += g_days_in_month[i];
        if (gm > 2 && ((gy % 4 === 0 && gy % 100 !== 0) || (gy % 400 === 0)))
            g_day_no++;

        g_day_no += gd - 1;

        let j_day_no = g_day_no - 79;

        let j_np = div(j_day_no, 12053);
        j_day_no %= 12053;

        let jy = 979 + 33 * j_np + 4 * div(j_day_no, 1461);
        j_day_no %= 1461;

        if (j_day_no >= 366) {
            jy += div(j_day_no - 1, 365);
            j_day_no = (j_day_no - 1) % 365;
        }

        let jm, jd;
        for (jm = 0; jm < 11 && j_day_no >= j_days_in_month[jm]; ++jm)
            j_day_no -= j_days_in_month[jm];
        jd = j_day_no + 1;

        return { jy, jm: jm + 1, jd };
    }

    try {
        // ورودی مثل: "2025-07-31T09:18:41.000Z"
        // حذف T و قسمت میلی‌ثانیه
        const cleaned = dateStr.replace('T', ' ').split('.')[0];
        const [datePart, timePart] = cleaned.split(' ');
        const [gy, gm, gd] = datePart.split('-').map(Number);
        const [hh, mm] = timePart.split(':');

        const { jy, jm, jd } = gregorianToJalali(gy, gm, gd);
        return `${jy}/${String(jm).padStart(2, '0')}/${String(jd).padStart(2, '0')} - ${hh}:${mm}`;
    } catch (e) {
        return 'تاریخ نامعتبر';
    }
}


    const table = new Tabulator("#log-table", {
        layout: "fitColumns",
        placeholder: "هیچ لاگی برای نمایش وجود ندارد.",
        ajaxURL: "/api/logs",
        ajaxResponse: function(url, params, response) {
            // تبدیل تاریخ‌ها به شمسی
            return response.data.map(log => ({
                ...log,
                createdAtPersian: toPersianDate(log.createdAt),
            }));
        },
        columns: [
            { title: "شناسه", field: "id", sorter: "number", width: 80 },
            { title: "توضیحات", field: "description", sorter: "string", headerFilter: "input" },
            { title: "تاریخ", field: "createdAtPersian", sorter: "string", width: 160 }
        ],
        pagination: true,
        paginationSize: 10,
        paginationSizeSelector: [10, 20, 50],
        movableColumns: true,
        responsiveLayout: "collapse",
        langs: {
            "fa": {
                "pagination": {
                    "first": "اول",
                    "first_title": "صفحه اول",
                    "last": "آخر",
                    "last_title": "صفحه آخر",
                    "prev": "قبلی",
                    "prev_title": "صفحه قبلی",
                    "next": "بعدی",
                    "next_title": "صفحه بعدی",
                }
            }
        },
        locale: "fa"
    });
</script>